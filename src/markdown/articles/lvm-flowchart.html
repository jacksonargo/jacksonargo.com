<!DOCTYPE html>
<html lang="en-US">
<head>

<!-- Latest compiled and minified CSS -->
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">

<!-- Optional theme -->
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap-theme.min.css" integrity="sha384-rHyoN1iRsVXV4nD0JutlnGaslCJuC7uwjduW9SVrLvRYooPp2bWYgmgJQIXwl/Sp" crossorigin="anonymous">

<!-- Latest compiled and minified JavaScript -->
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>

</head>

<body>

<div class="container">

<nav class="navbar navbar-default">
  <div class="container-fluid">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="/">Home</a>
    </div>
    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
      <ul class="nav navbar-nav">
        <li><a href="https://github.com/jacksonargo/resume/blob/master/main.pdf">Resume</a></li>
        <li><a href="https://github.com/jacksonargo">Github</a></li>
        <li><a href="/articles/">Articles</a></li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li><a href="https://github.com/jacksonargo/jacksonargo.com">Clone Me!</a></li>
        </li>
      </ul>
    </div><!-- /.navbar-collapse -->
  </div><!-- /.container-fluid -->
</nav>
<h1>LVM Flow chart</h1>

<p>A flow chart for changing disk space via lvm.</p>

<h2>Adding space to a filesystem</h2>

<ol>
<li>
<p>Is there space in the volume group?</p>

<pre><code># vgs
  VG         #PV #LV #SN Attr   VSize  VFree
  volgroup00   2   1   0 wz--n- 19.99g 9.99g
</code></pre>

<ul>
<li>If yes, skip to 17.</li>
<li>If no, continue to 2.</li>
</ul>
</li>
<li>
<p>Are the physical volumes in the volume group on partitions?</p>

<pre><code># pvs
  PV         VG         Fmt  Attr PSize  PFree 
  /dev/xvdb1 volgroup00 lvm2 a--  10.00g 10.00g
  /dev/xvdb2 volgroup00 lvm2 a--  10.00g 10.00g
  /dev/xvdc  volgroup01 lvm2 a--  25.00g 25.00g
</code></pre>

<p>This is a device with partitions:</p>

<pre><code>  # parted /dev/xvdb unit gib print
  Model: Xen Virtual Block Device (xvd)
  Disk /dev/xvdb: 50.0GiB
  Sector size (logical/physical): 512B/512B
  Partition Table: gpt
  Disk Flags: 

  Number  Start    End      Size     File system  Name     Flags
   1      0.00GiB  10.0GiB  10.0GiB               primary  lvm
   2      10.0GiB  20.0GiB  10.0GiB               primary  lvm
</code></pre>

<p>This is a device without partitions:</p>

<pre><code>  # parted /dev/xvdc unit gib print
  Error: /dev/xvdc: unrecognised disk label
  Model: Xen Virtual Block Device (xvd)                                     
  Disk /dev/xvdc: 50.0GiB
  Sector size (logical/physical): 512B/512B
  Partition Table: unknown
  Disk Flags: 
</code></pre>

<ul>
<li>If yes, skip to 13.</li>
<li>If no, continue to 3.</li>
</ul>
</li>
<li>
<p>Is the device entire used?</p>

<pre><code># pvs
  PV         VG         Fmt  Attr PSize  PFree 
  /dev/xvdc  volgroup01 lvm2 a--  25.00g 25.00g

# parted /dev/xvdc unit gib print
Error: /dev/xvdc: unrecognised disk label
Model: Xen Virtual Block Device (xvd)                                     
Disk /dev/xvdc: 50.0GiB
Sector size (logical/physical): 512B/512B
Partition Table: unknown
Disk Flags: 
</code></pre>

<ul>
<li>If yes, continue to 4.</li>
<li>If no, skip to 7.</li>
</ul>
</li>
<li>
<p>Can you increase the size of the device?</p>

<ul>
<li>If yes, continue to 5.</li>
<li>If no, skip to 9.</li>
</ul>
</li>
<li><p>Increase the size of the device.</p></li>
<li>
<p>Rescan the device so the kernel recognizes the new size.</p>

<pre><code>echo 1 &gt; /sys/block/xvdc/device/rescan
</code></pre>
</li>
<li>
<p>Increase the size of the physical volume.</p>

<pre><code># vgs
  VG         #PV #LV #SN Attr   VSize  VFree 
  volgroup01   1   0   0 wz--n- 25.00g 25.00g

# pvs
  PV         VG         Fmt  Attr PSize  PFree 
  /dev/xvdc  volgroup01 lvm2 a--  25.00g 25.00g

# pvresize /dev/xvdc
  Physical volume "/dev/xvdc" changed
  1 physical volume(s) resized / 0 physical volume(s) not resized

# pvs
  PV         VG         Fmt  Attr PSize  PFree 
  /dev/xvdc  volgroup01 lvm2 a--  50.00g 50.00g

# vgs
  VG         #PV #LV #SN Attr   VSize  VFree 
  volgroup01   1   0   0 wz--n- 50.00g 50.00g
</code></pre>
</li>
<li><p>Skip to 17.</p></li>
<li><p>Add a new device.</p></li>
<li>
<p>Scan the scsi host for the new device.</p>

<pre><code># echo "- - -" &gt; /sys/class/scsi_host/host0/scan
</code></pre>
</li>
<li>
<p>Create a partition on the new device.</p>

<pre><code># parted /dev/xvdc mklabel gpt
# parted /dev/xvdc mkpart primary 0% 100%
</code></pre>
</li>
<li><p>Go to 15.</p></li>
<li>
<p>Is there space available to add a new partition?</p>

<ul>
<li>If yes, continue to 14.</li>
<li>If no, go to 9.</li>
</ul>

<p>Using parted, we can check where the last filesystem ends and how much space is on the disk. </p>

<pre><code>  # parted /dev/xvdb unit gib print free
  Model: Xen Virtual Block Device (xvd)
  Disk /dev/xvdb: 50.0GiB
  Sector size (logical/physical): 512B/512B
  Partition Table: gpt
  Disk Flags: 

  Number  Start    End      Size     File system  Name     Flags
          0.00GiB  0.00GiB  0.00GiB  Free Space
   1      0.00GiB  10.0GiB  10.0GiB               primary  lvm
   2      10.0GiB  20.0GiB  10.0GiB               primary  lvm
          20.0GiB  50.0GiB  30.0GiB  Free Space
</code></pre>
</li>
<li>
<p>Use parted to create a new lvm partition.</p>

<pre><code># parted /dev/xvdb unit gib print
Model: Xen Virtual Block Device (xvd)
Disk /dev/xvdb: 50.0GiB
Sector size (logical/physical): 512B/512B
Partition Table: gpt
Disk Flags: 

Number  Start    End      Size     File system  Name     Flags
 1      0.00GiB  10.0GiB  10.0GiB               primary  lvm
 2      10.0GiB  20.0GiB  10.0GiB               primary  lvm

# parted /dev/xvdb mkpart primary 20GiB 30GiB

# parted /dev/xvdb set 3 lvm on

# parted /dev/xvdb unit gib print
Model: Xen Virtual Block Device (xvd)
Disk /dev/xvdb: 50.0GiB
Sector size (logical/physical): 512B/512B
Partition Table: gpt
Disk Flags: 

Number  Start    End      Size     File system  Name     Flags
 1      0.00GiB  10.0GiB  10.0GiB               primary  lvm
 2      10.0GiB  20.0GiB  10.0GiB               primary  lvm
 3      20.0GiB  30.0GiB  10.0GiB               primary  lvm
</code></pre>
</li>
<li>
<p>Use pvcreate to convert the new partition into a physical volume.</p>

<pre><code># pvs
  PV         VG   Fmt  Attr PSize  PFree 
  /dev/xvdb1      lvm2 ---  10.00g 10.00g
  /dev/xvdb2      lvm2 ---  10.00g 10.00g

# pvcreate /dev/xvdb3

# pvs
  PV         VG   Fmt  Attr PSize  PFree 
  /dev/xvdb1      lvm2 ---  10.00g 10.00g
  /dev/xvdb2      lvm2 ---  10.00g 10.00g
  /dev/xvdb3      lvm2 ---  10.00g 10.00g
</code></pre>
</li>
<li>
<p>Use vgextend to extend the volume group with the new physical volume.</p>

<pre><code># vgs
  VG         #PV #LV #SN Attr   VSize  VFree
  volgroup00   2   1   0 wz--n- 19.99g 9.99g

# vgextend volgroup00 /dev/xvdb3
  Volume group "volgroup00" successfully extended

 # vgs
  VG         #PV #LV #SN Attr   VSize  VFree
  volgroup00   2   1   0 wz--n- 29.99g 19.99g
</code></pre>
</li>
<li>
<p>Use lvextend to increase the size of the logical partition.</p>

<pre><code># lvs
  LV    VG         Attr       LSize  Pool Origin Data%  Meta%  Move Log Cpy%Sync Convert
  lvol0 volgroup00 -wi-a----- 10.00g
</code></pre>

<p>We can extend with a specific size:</p>

<pre><code>  # lvextend -L +5GiB /dev/mapper/volgroup00-lvol0 
    Size of logical volume volgroup00/lvol0 changed from 10.00 GiB (2560 extents) to 15.00 GiB (3840 extents).
    Logical volume lvol0 successfully resized.

  # lvs 
    LV    VG         Attr       LSize  Pool Origin Data%  Meta%  Move Log Cpy%Sync Convert
    lvol0 volgroup00 -wi-a----- 15.00g
</code></pre>

<p>We can fill the entire device:</p>

<pre><code>  # lvextend -l +100%FREE /dev/mapper/volgroup00-lvol0 
    Size of logical volume volgroup00/lvol0 changed from 15.00 GiB (3840 extents) to 29.99 GiB (7677 extents).
    Logical volume lvol0 successfully resized.

  # lvs 
    LV    VG         Attr       LSize  Pool Origin Data%  Meta%  Move Log Cpy%Sync Convert
    lvol0 volgroup00 -wi-a----- 29.99g
</code></pre>
</li>
<li>
<p>Use <strong>resize2fs</strong> or <strong>xfs_growfs</strong> to make the filesystem fill the partition.</p>

<p>Resizing an <strong>ext4</strong> filesystem:</p>

<pre><code>  # df -h /dev/volgroup00/lvol0
  Filesystem                    Size  Used Avail Use% Mounted on
  /dev/mapper/volgroup00-lvol0   20G   45M   19G   1% /mnt/volgroup00/lvol0

  # resize2fs /dev/volgroup00/lvol0
  resize2fs 1.42.9 (28-Dec-2013)
  Filesystem at /dev/volgroup00/lvol0 is mounted on /mnt/volgroup00/lvol0; on-line resizing required
  old_desc_blocks = 3, new_desc_blocks = 4
  The filesystem on /dev/volgroup00/lvol0 is now 7859200 blocks long.

  # df -h /dev/volgroup00/lvol0
  Filesystem                    Size  Used Avail Use% Mounted on
  /dev/mapper/volgroup00-lvol0   30G   44M   28G   1% /mnt/volgroup00/lvol0
</code></pre>

<p>Reszing an <strong>xfs</strong> filesystem:</p>

<pre><code>  # df -h /mnt/volgroup00/lvol0
  Filesystem                    Size  Used Avail Use% Mounted on
  /dev/mapper/volgroup00-lvol0   35G   33M   35G   1% /mnt/volgroup00/lvol0

  # xfs_growfs /dev/volgroup00/lvol0
  meta-data=/dev/mapper/volgroup00-lvol0 isize=256    agcount=5, agsize=1964800 blks
           =                       sectsz=512   attr=2, projid32bit=1
           =                       crc=0        finobt=0
  data     =                       bsize=4096   blocks=9169920, imaxpct=25
           =                       sunit=0      swidth=0 blks
  naming   =version 2              bsize=4096   ascii-ci=0 ftype=0
  log      =internal               bsize=4096   blocks=3837, version=2
           =                       sectsz=512   sunit=0 blks, lazy-count=1
  realtime =none                   extsz=4096   blocks=0, rtextents=0

  # df -h /mnt/volgroup00/lvol0
  Filesystem                    Size  Used Avail Use% Mounted on
  /dev/mapper/volgroup00-lvol0   42G   33M   42G   1% /mnt/volgroup00/lvol0
</code></pre>
</li>
<li><p>You are done!</p></li>
</ol>
</div>

</body>

</html>
